<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>人物形象 - AstrBot</title>
    <meta name="referrer" content="no-referrer">
    <!-- Preconnect for faster resource loading -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="dns-prefetch" href="https://cdn.tailwindcss.com">
    <link rel="dns-prefetch" href="https://unpkg.com">
    <!-- Tailwind CSS (Runtime parser) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Element Plus -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus@2.4.4/dist/index.css" />
    <!-- Vue 3 & Libs (Deferred for faster FCP) -->
    <script src="https://unpkg.com/vue@3.4.15/dist/vue.global.prod.js" defer></script>
    <script src="https://unpkg.com/element-plus@2.4.4/dist/index.full.min.js" defer></script>
    <!-- SortableJS for drag-drop -->
    <script src="https://unpkg.com/sortablejs@1.15.0/Sortable.min.js" defer></script>
    <style>
        :root {
            --primary-pink: #FF69B4;
            --soft-pink: #FFB6C1;
            --light-pink: #FFF0F5;
            --accent-lavender: #E6E6FA;
            --text-primary: #4a4a4a;
            --text-accent: #d8659f;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background: linear-gradient(135deg, var(--light-pink) 0%, #FFE4E1 50%, var(--accent-lavender) 100%);
            background-attachment: fixed;
            color: var(--text-primary);
            font-family: 'PingFang SC', 'Microsoft YaHei', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
        }
        /* Element Plus 粉色主题覆盖 */
        .el-card {
            --el-card-bg-color: rgba(255, 255, 255, 0.85);
            --el-card-border-color: rgba(255, 182, 193, 0.4);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 20px !important;
            box-shadow: 0 8px 32px rgba(255, 182, 193, 0.25);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(255, 182, 193, 0.3) !important;
        }
        .el-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 16px 48px rgba(255, 105, 180, 0.25);
        }
        .el-card__header {
            border-bottom: 1px solid rgba(255, 182, 193, 0.4) !important;
            padding: 16px 20px !important;
            background: linear-gradient(135deg, rgba(255, 182, 193, 0.1) 0%, rgba(230, 230, 250, 0.1) 100%);
            border-radius: 20px 20px 0 0 !important;
        }
        .el-input__wrapper, .el-textarea__inner {
            background-color: rgba(255, 255, 255, 0.9) !important;
            box-shadow: 0 0 0 1px rgba(255, 182, 193, 0.5) inset !important;
            border-radius: 12px !important;
            transition: all 0.2s ease;
        }
        .el-input__wrapper:hover, .el-textarea__inner:hover {
            box-shadow: 0 0 0 1px rgba(255, 105, 180, 0.6) inset !important;
        }
        .el-input__wrapper:focus-within, .el-textarea__inner:focus {
            box-shadow: 0 0 0 2px rgba(255, 105, 180, 0.5) inset !important;
        }
        .el-input__inner, .el-textarea__inner {
            color: #4a4a4a !important;
        }
        .el-form-item__label {
            color: var(--text-accent) !important;
            font-weight: 600 !important;
        }
        .el-switch__label {
            color: #888 !important;
        }
        .el-button--primary {
            background: linear-gradient(135deg, var(--soft-pink) 0%, #DDA0DD 100%) !important;
            border: none !important;
            box-shadow: 0 4px 15px rgba(255, 182, 193, 0.5);
            transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
            color: #fff !important;
        }
        .el-button--primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 105, 180, 0.5);
            background: linear-gradient(135deg, var(--primary-pink) 0%, #DA70D6 100%) !important;
        }
        .el-button--success {
            background: linear-gradient(135deg, #98D8C8 0%, #90EE90 100%) !important;
            border: none !important;
        }
        .el-button--danger {
            background: linear-gradient(135deg, #FFB4B4 0%, #FF6B6B 100%) !important;
            border: none !important;
        }
        .el-select__wrapper {
            background-color: rgba(255, 255, 255, 0.9) !important;
            box-shadow: 0 0 0 1px rgba(255, 182, 193, 0.5) inset !important;
        }
        .el-input-number {
            --el-input-bg-color: rgba(255, 255, 255, 0.9);
        }
        /* 侧边栏 */
        .sidebar {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 240, 245, 0.95) 100%);
            border-right: 1px solid rgba(255, 182, 193, 0.3);
            backdrop-filter: blur(20px);
        }
        .logo-section {
            padding: 24px 20px;
            border-bottom: 1px solid rgba(255, 182, 193, 0.3);
            background: linear-gradient(135deg, rgba(255, 182, 193, 0.2) 0%, rgba(230, 230, 250, 0.2) 100%);
        }
        .logo-title {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #FF69B4 0%, #DA70D6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .nav-item {
            padding: 14px 24px;
            margin: 4px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #888;
        }
        .nav-item:hover {
            background: rgba(255, 182, 193, 0.2);
            color: #FF69B4;
        }
        .nav-item.active {
            background: linear-gradient(135deg, rgba(255, 182, 193, 0.3) 0%, rgba(230, 230, 250, 0.3) 100%);
            color: #FF69B4;
            font-weight: 600;
        }
        .nav-item .icon {
            font-size: 1.2rem;
        }
        /* 图片卡片 */
        .image-card {
            position: relative;
            overflow: hidden;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 182, 193, 0.3);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            content-visibility: auto;
            contain-intrinsic-size: 300px; /* Estimated height */
            will-change: transform, box-shadow; /* GPU acceleration */
        }
        .image-card:hover {
            border-color: rgba(255, 105, 180, 0.5);
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 40px rgba(255, 105, 180, 0.2);
        }
        .image-card img {
            width: 100%;
            height: 300px;
            object-fit: cover;
            transition: transform 0.3s ease;
            will-change: transform; /* GPU acceleration */
        }
        .image-card:hover img {
            transform: scale(1.05);
        }
        .image-card .actions {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 182, 193, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .image-card:hover .actions {
            opacity: 1;
        }
        .image-card .actions .flex {
            pointer-events: auto;
        }
        .image-card .actions .el-button {
            pointer-events: auto;
        }
        .image-card .image-info {
            padding: 12px;
            background: rgba(255, 255, 255, 0.95);
        }
        /* 页面标题 */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 182, 193, 0.3);
        }
        .page-title {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, #FF69B4 0%, #DA70D6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        /* 卡片标题 */
        .card-title {
            font-weight: 600;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #d8659f;
        }
        .card-title .icon {
            font-size: 1.2rem;
        }
        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #bbb;
        }
        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        /* 统计卡片 */
        .stats-bar {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-item {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 16px 24px;
            border: 1px solid rgba(255, 182, 193, 0.3);
            flex: 1;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #FF69B4;
        }
        .stat-label {
            font-size: 0.875rem;
            color: #aaa;
            margin-top: 4px;
        }
        /* 动态列表项 */
        .list-item {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 182, 193, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }
        .list-item:hover {
            border-color: rgba(255, 105, 180, 0.5);
            box-shadow: 0 4px 16px rgba(255, 182, 193, 0.2);
        }
        .list-item.sortable-ghost {
            opacity: 0.5;
            background: rgba(255, 182, 193, 0.2);
        }
        .list-item.sortable-drag {
            box-shadow: 0 8px 24px rgba(255, 105, 180, 0.3);
        }
        .drag-handle {
            cursor: grab;
            color: #ccc;
            transition: color 0.2s;
        }
        .drag-handle:hover {
            color: #FF69B4;
        }
        .keyword-tag {
            background: linear-gradient(135deg, #FFE4E1 0%, #E6E6FA 100%);
            color: #d8659f;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 12px;
            margin-right: 4px;
            margin-bottom: 4px;
            display: inline-block;
        }
        /* 滚动条 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 240, 245, 0.5);
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 182, 193, 0.5);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 105, 180, 0.6);
        }
        /* 动画 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        /* 登录卡片 */
        .login-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 48px 40px;
            box-shadow: 0 20px 60px rgba(255, 182, 193, 0.3);
            border: 1px solid rgba(255, 182, 193, 0.3);
            width: 100%;
            max-width: 400px;
            animation: fadeIn 0.5s ease-out;
        }
        /* 移动端汉堡菜单按钮 */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 1001;
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 182, 193, 0.4);
            box-shadow: 0 4px 16px rgba(255, 182, 193, 0.3);
            cursor: pointer;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        /* 移动端遮罩层 */
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 999;
        }
        /* 移动端适配 */
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: flex;
            }
            .mobile-overlay.show {
                display: block;
            }
            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                bottom: 0;
                width: 280px !important;
                z-index: 1000;
                transition: left 0.3s ease;
            }
            .sidebar.open {
                left: 0;
            }
            .main-content {
                margin-left: 0 !important;
                padding: 70px 16px 16px 16px !important;
            }
            .page-header {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }
            .page-title {
                font-size: 1.4rem;
            }
            .stats-bar {
                flex-wrap: wrap;
            }
            .stat-item {
                flex: 1 1 45%;
                min-width: 120px;
                padding: 12px 16px;
            }
            .stat-value {
                font-size: 1.2rem;
            }
            .image-card img {
                height: 180px;
            }
            .login-card {
                padding: 32px 24px;
                margin: 16px;
            }
            .el-dialog {
                width: 95% !important;
                margin: 10px auto !important;
            }
            .list-item {
                padding: 12px;
            }
            .el-form-item {
                margin-bottom: 16px;
            }
        }
        /* 小屏幕手机 */
        @media (max-width: 480px) {
            .stat-item {
                flex: 1 1 100%;
            }
            .image-card img {
                height: 150px;
            }
            .page-header .flex {
                width: 100%;
                flex-wrap: wrap;
                gap: 8px;
            }
            .page-header .el-button {
                flex: 1;
            }
        }
        /* 去掉 el-divider 文字的白色背景 */
        .el-divider__text {
            background-color: transparent !important;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- 登录页面 -->
        <div v-if="!isAuthenticated" class="min-h-screen flex items-center justify-center">
            <div class="login-card">
                <div class="text-center mb-8">
                    <h1 class="logo-title text-3xl mb-2">人物形象</h1>
                    <p class="text-pink-400 text-sm">AstrBot 角色视觉管理器</p>
                </div>
                <el-form @submit.prevent="doLogin">
                    <el-form-item>
                        <el-input
                            v-model="loginToken"
                            type="password"
                            placeholder="请输入访问令牌"
                            size="large"
                            show-password
                            @keyup.enter="doLogin"
                        >
                            <template #prefix>
                                <span style="font-size: 1.1rem;">&#128274;</span>
                            </template>
                        </el-input>
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" size="large" style="width: 100%;" :loading="loggingIn" @click="doLogin">
                            进入管理面板
                        </el-button>
                    </el-form-item>
                </el-form>
                <p v-if="loginError" class="text-red-400 text-sm text-center mt-4">{{ loginError }}</p>
                <p class="text-gray-400 text-xs text-center mt-6">v3.2.0</p>
            </div>
        </div>

        <!-- 主界面 -->
        <div v-else class="flex h-screen">
            <!-- 移动端菜单按钮 -->
            <div class="mobile-menu-btn"
                 @click="mobileMenuOpen = !mobileMenuOpen"
                 @keyup.enter="mobileMenuOpen = !mobileMenuOpen"
                 @keyup.escape="mobileMenuOpen = false"
                 role="button"
                 tabindex="0"
                 :aria-expanded="mobileMenuOpen"
                 aria-label="切换菜单">
                <span v-if="!mobileMenuOpen">&#9776;</span>
                <span v-else>&#10005;</span>
            </div>
            <!-- 移动端遮罩层 -->
            <div class="mobile-overlay"
                 :class="{ show: mobileMenuOpen }"
                 @click="mobileMenuOpen = false"
                 @keyup.escape="mobileMenuOpen = false"
                 aria-hidden="true"></div>
            <!-- 侧边栏 -->
            <div class="sidebar w-64 flex-shrink-0 flex flex-col" :class="{ open: mobileMenuOpen }">
                <div class="logo-section">
                    <h1 class="logo-title">人物形象</h1>
                    <p class="text-xs text-pink-400 mt-2">AstrBot 角色视觉管理器</p>
                </div>
                <nav class="py-6 flex-1" role="navigation" aria-label="主导航">
                    <div class="nav-item" :class="{ active: activeTab === 'settings' }" @click="activeTab = 'settings'; mobileMenuOpen = false" @keyup.enter="activeTab = 'settings'" tabindex="0" role="button" aria-pressed="activeTab === 'settings'">
                        <span class="icon">&#9881;</span>
                        <span>配置设置</span>
                    </div>
                    <div class="nav-item" :class="{ active: activeTab === 'environments' }" @click="activeTab = 'environments'; mobileMenuOpen = false" @keyup.enter="activeTab = 'environments'" tabindex="0" role="button" aria-pressed="activeTab === 'environments'">
                        <span class="icon">&#127968;</span>
                        <span>环境场景</span>
                    </div>
                    <div class="nav-item" :class="{ active: activeTab === 'cameras' }" @click="activeTab = 'cameras'; mobileMenuOpen = false" @keyup.enter="activeTab = 'cameras'" tabindex="0" role="button" aria-pressed="activeTab === 'cameras'">
                        <span class="icon">&#128247;</span>
                        <span>摄影模式</span>
                    </div>
                    <div class="nav-item" :class="{ active: activeTab === 'selfie' }" @click="activeTab = 'selfie'; mobileMenuOpen = false" @keyup.enter="activeTab = 'selfie'" tabindex="0" role="button" aria-pressed="activeTab === 'selfie'">
                        <span class="icon">&#128248;</span>
                        <span>人像参考</span>
                    </div>
                    <div class="nav-item" :class="{ active: activeTab === 'gallery' }" @click="activeTab = 'gallery'; mobileMenuOpen = false" @keyup.enter="activeTab = 'gallery'" tabindex="0" role="button" aria-pressed="activeTab === 'gallery'">
                        <span class="icon">&#128444;</span>
                        <span>图片画廊</span>
                    </div>
                    <!-- 画廊每行图片数量滑块 -->
                    <div v-if="activeTab === 'gallery'" class="py-3" style="padding-left: 30px;">
                        <div class="text-xs text-gray-400 mb-2">每行 {{ galleryColumns }} 张</div>
                        <el-slider v-model="galleryColumns" :min="2" :max="10" :step="1" :show-tooltip="false" size="small" @change="saveGalleryColumns" style="width: 180px;" />
                    </div>
                    <div class="nav-item" :class="{ active: activeTab === 'videos' }" @click="activeTab = 'videos'; mobileMenuOpen = false" @keyup.enter="activeTab = 'videos'" tabindex="0" role="button" aria-pressed="activeTab === 'videos'">
                        <span class="icon">&#127916;</span>
                        <span>视频画廊</span>
                    </div>
                    <!-- 视频画廊每行数量滑块 -->
                    <div v-if="activeTab === 'videos'" class="py-3" style="padding-left: 30px;">
                        <div class="text-xs text-gray-400 mb-2">每行 {{ videoColumns }} 个</div>
                        <el-slider v-model="videoColumns" :min="4" :max="6" :step="1" :show-tooltip="false" size="small" @change="saveVideoColumns" style="width: 180px;" />
                    </div>
                    <div class="nav-item" :class="{ active: activeTab === 'videoPresets' }" @click="activeTab = 'videoPresets'; mobileMenuOpen = false" @keyup.enter="activeTab = 'videoPresets'" tabindex="0" role="button" aria-pressed="activeTab === 'videoPresets'">
                        <span class="icon">&#128221;</span>
                        <span>预设词设置</span>
                    </div>
                </nav>
                <div class="p-4 border-t border-pink-200/30">
                    <p class="text-xs text-pink-300 text-center">v3.2.0</p>
                </div>
            </div>

            <!-- 主内容区 -->
            <div class="main-content flex-1 overflow-auto p-8">
                <!-- 配置页面 -->
                <div v-if="activeTab === 'settings'" class="max-w-4xl mx-auto fade-in">
                    <div class="page-header">
                        <h2 class="page-title">配置设置</h2>
                        <el-button type="primary" size="large" :loading="saving" @click="saveConfig">
                            <span style="margin-right: 8px;">&#128190;</span> 保存更改
                        </el-button>
                    </div>

                    <!-- 人物特征卡片 -->
                    <el-card class="mb-6">
                        <template #header>
                            <div class="card-title">
                                <span class="icon">&#128100;</span>
                                <span>人物特征</span>
                            </div>
                        </template>
                        <el-form label-position="top">
                            <el-form-item label="角色外貌描述">
                                <el-input
                                    v-model="config.char_identity"
                                    type="textarea"
                                    :autosize="{ minRows: 4, maxRows: 12 }"
                                    placeholder="描述角色的固定外貌特征，建议使用英文 Prompt 格式。例如: The subject is a young Asian girl with fair skin, dusty rose pink hair, large round eyes..."
                                />
                                <p class="text-xs text-pink-400 mt-2">此描述会在检测到绘图意图时注入到 LLM 上下文中</p>
                            </el-form-item>
                            <el-form-item label="连续注入轮次">
                                <div class="flex items-center gap-4">
                                    <el-input-number v-model="config.injection_rounds" :min="1" :max="10" />
                                    <span class="text-sm text-gray-500">检测到绘图意图后，连续多少轮对话注入视觉上下文</span>
                                </div>
                            </el-form-item>
                            <el-form-item label="画图冷却时间（秒）">
                                <div class="flex items-center gap-4">
                                    <el-slider v-model="config.cooldown_seconds" :min="0" :max="300" :step="5" style="width: 200px;" />
                                    <span class="text-sm text-gray-500">{{ config.cooldown_seconds }}秒，0 表示无冷却</span>
                                </div>
                            </el-form-item>
                            <el-row :gutter="24">
                                <el-col :span="8">
                                    <el-form-item label="启用环境场景注入">
                                        <el-switch v-model="config.enable_env_injection" />
                                    </el-form-item>
                                </el-col>
                                <el-col :span="8">
                                    <el-form-item label="启用摄影模式注入">
                                        <el-switch v-model="config.enable_camera_injection" />
                                    </el-form-item>
                                </el-col>
                                <el-col :span="8">
                                    <el-form-item label="HTTP 代理">
                                        <el-input v-model="config.proxy" placeholder="http://127.0.0.1:7890" />
                                    </el-form-item>
                                </el-col>
                            </el-row>
                        </el-form>
                    </el-card>

                    <!-- Gitee AI 配置卡片 -->
                    <el-card class="mb-6">
                        <template #header>
                            <div class="card-title">
                                <span class="icon">&#127912;</span>
                                <span>Gitee AI 文生图</span>
                            </div>
                        </template>
                        <el-form label-position="top">
                            <el-form-item label="API 密钥（每行一个）">
                                <el-input
                                    v-model="giteeKeysText"
                                    :type="showGiteeKeys ? 'textarea' : 'password'"
                                    :autosize="{ minRows: 2, maxRows: 4 }"
                                    placeholder="从 https://ai.gitee.com 获取 API Key"
                                >
                                    <template #suffix>
                                        <span @click="showGiteeKeys = !showGiteeKeys" style="cursor: pointer; font-size: 1.1rem;">
                                            {{ showGiteeKeys ? '&#128065;' : '&#128586;' }}
                                        </span>
                                    </template>
                                </el-input>
                            </el-form-item>
                            <el-form-item label="Base URL">
                                <el-input v-model="giteeConfig.base_url" placeholder="https://ai.gitee.com/v1" />
                            </el-form-item>
                            <el-row :gutter="24">
                                <el-col :span="12">
                                    <el-form-item label="模型名称">
                                        <el-input v-model="giteeConfig.model" placeholder="z-image-turbo" />
                                        <p class="text-xs text-pink-400 mt-1">常用: z-image-turbo, z-image-base, flux.1-dev</p>
                                    </el-form-item>
                                </el-col>
                                <el-col :span="12">
                                    <el-form-item label="默认尺寸">
                                        <el-select v-model="giteeConfig.size" style="width: 100%" placeholder="选择尺寸">
                                            <el-option
                                                v-for="item in sizeOptions"
                                                :key="item.value"
                                                :value="item.value"
                                                :label="item.label"
                                            />
                                        </el-select>
                                    </el-form-item>
                                </el-col>
                            </el-row>
                            <el-row :gutter="24">
                                <el-col :span="8">
                                    <el-form-item label="推理步数">
                                        <el-input-number v-model="giteeConfig.num_inference_steps" :min="1" :max="20" style="width: 100%" />
                                    </el-form-item>
                                </el-col>
                                <el-col :span="8">
                                    <el-form-item label="超时时间（秒）">
                                        <el-input-number v-model="giteeConfig.timeout" :min="30" :max="600" style="width: 100%" />
                                    </el-form-item>
                                </el-col>
                                <el-col :span="8">
                                    <el-form-item label="最大重试次数">
                                        <el-input-number v-model="giteeConfig.max_retries" :min="0" :max="5" style="width: 100%" />
                                    </el-form-item>
                                </el-col>
                            </el-row>
                                </el-col>
                            </el-row>
                            <el-form-item label="负面提示词">
                                <el-input
                                    v-model="giteeConfig.negative_prompt"
                                    type="textarea"
                                    :autosize="{ minRows: 2, maxRows: 4 }"
                                    placeholder="不希望出现在图片中的内容（注意：部分模型不支持）"
                                />
                            </el-form-item>
                        </el-form>
                    </el-card>

                    <!-- Gemini AI 配置卡片 -->
                    <el-card class="mb-6">
                        <template #header>
                            <div class="card-title">
                                <span class="icon">&#129302;</span>
                                <span>Gemini AI 文生图（备用）</span>
                            </div>
                        </template>
                        <el-form label-position="top">
                            <el-form-item label="API 密钥">
                                <el-input
                                    v-model="geminiConfig.api_key"
                                    :type="showGeminiKey ? 'text' : 'password'"
                                    placeholder="从 https://aistudio.google.com/apikey 获取"
                                >
                                    <template #suffix>
                                        <span @click="showGeminiKey = !showGeminiKey" style="cursor: pointer; font-size: 1.1rem;">
                                            {{ showGeminiKey ? '&#128065;' : '&#128586;' }}
                                        </span>
                                    </template>
                                </el-input>
                            </el-form-item>
                            <el-form-item label="Base URL">
                                <el-input
                                    v-model="geminiConfig.base_url"
                                    placeholder="https://generativelanguage.googleapis.com"
                                />
                                <p class="text-xs text-pink-400 mt-1">仅填写域名，默认使用原生接口，失败时回退到 OpenAI 兼容接口</p>
                            </el-form-item>
                            <el-row :gutter="24">
                                <el-col :span="8">
                                    <el-form-item label="模型名称">
                                        <el-input v-model="geminiConfig.model" placeholder="gemini-2.0-flash-exp-image-generation" />
                                        <p class="text-xs text-pink-400 mt-1">常用: gemini-2.0-flash-exp, gemini-3-pro</p>
                                    </el-form-item>
                                </el-col>
                                <el-col :span="8">
                                    <el-form-item label="图片分辨率">
                                        <el-select v-model="geminiConfig.image_size" style="width: 100%">
                                            <el-option value="1K" label="1K" />
                                            <el-option value="2K" label="2K" />
                                            <el-option value="4K" label="4K" />
                                        </el-select>
                                        <p class="text-xs text-pink-400 mt-1">2K/4K 仅 gemini-3 系列支持</p>
                                    </el-form-item>
                                </el-col>
                                <el-col :span="8">
                                    <el-form-item label="超时时间（秒）">
                                        <el-input-number v-model="geminiConfig.timeout" :min="30" :max="300" style="width: 100%" />
                                    </el-form-item>
                                </el-col>
                            </el-row>
                        </el-form>
                    </el-card>

                    <!-- Grok AI 配置卡片 -->
                    <el-card class="mb-6">
                        <template #header>
                            <div class="card-title">
                                <span class="icon">&#129430;</span>
                                <span>Grok AI（图片+视频）</span>
                            </div>
                        </template>
                        <el-form label-position="top">
                            <el-row :gutter="24">
                                <el-col :span="12">
                                    <el-form-item label="API 密钥">
                                        <el-input
                                            v-model="grokConfig.api_key"
                                            :type="showGrokKey ? 'text' : 'password'"
                                            placeholder="从 x.ai 获取 API Key"
                                        >
                                            <template #suffix>
                                                <span @click="showGrokKey = !showGrokKey" style="cursor: pointer; font-size: 1.1rem;">
                                                    {{ showGrokKey ? '&#128065;' : '&#128586;' }}
                                                </span>
                                            </template>
                                        </el-input>
                                    </el-form-item>
                                </el-col>
                                <el-col :span="12">
                                    <el-form-item label="服务地址">
                                        <el-input v-model="grokConfig.base_url" placeholder="https://api.x.ai" />
                                    </el-form-item>
                                </el-col>
                            </el-row>
                            <el-row :gutter="24">
                                <el-col :span="8">
                                    <el-form-item label="图片模型">
                                        <el-input v-model="grokConfig.image_model" placeholder="grok-imagine-1.0" />
                                    </el-form-item>
                                </el-col>
                                <el-col :span="8">
                                    <el-form-item label="视频模型">
                                        <el-input v-model="grokConfig.video_model" placeholder="grok-imagine-1.0-video" />
                                    </el-form-item>
                                </el-col>
                                <el-col :span="8">
                                    <el-form-item label="默认图片尺寸">
                                        <el-select v-model="grokConfig.size" style="width: 100%">
                                            <el-option value="1024x1024" label="1024x1024" />
                                            <el-option value="2048x2048" label="2048x2048" />
                                            <el-option value="4096x4096" label="4096x4096" />
                                        </el-select>
                                    </el-form-item>
                                </el-col>
                            </el-row>
                            <el-row :gutter="24">
                                <el-col :span="6">
                                    <el-form-item label="超时(秒)">
                                        <el-input-number v-model="grokConfig.timeout" :min="30" :max="600" style="width: 100%" />
                                    </el-form-item>
                                </el-col>
                                <el-col :span="6">
                                    <el-form-item label="最大重试">
                                        <el-input-number v-model="grokConfig.max_retries" :min="0" :max="5" style="width: 100%" />
                                    </el-form-item>
                                </el-col>
                                <el-col :span="6">
                                    <el-form-item label="启用视频功能">
                                        <el-switch v-model="grokConfig.video_enabled" />
                                    </el-form-item>
                                </el-col>
                                <el-col :span="6">
                                    <el-form-item label="最大缓存视频数">
                                        <el-input-number v-model="grokConfig.max_cached_videos" :min="0" :max="500" style="width: 100%" />
                                    </el-form-item>
                                </el-col>
                            </el-row>
                            <el-form-item label="视频发送模式">
                                <el-select v-model="grokConfig.video_send_mode" style="width: 200px">
                                    <el-option value="auto" label="自动（先URL再文件）" />
                                    <el-option value="url" label="仅发送URL" />
                                    <el-option value="file" label="下载后发送文件" />
                                </el-select>
                            </el-form-item>
                        </el-form>
                    </el-card>

                    <!-- 提供商切换卡片 -->
                    <el-card class="mb-6">
                        <template #header>
                            <div class="card-title">
                                <span class="icon">&#128260;</span>
                                <span>提供商切换</span>
                            </div>
                        </template>
                        <el-form label-position="top">
                            <el-row :gutter="24">
                                <el-col :span="12">
                                    <el-form-item label="主图片生成提供商">
                                        <el-select v-model="providerConfig.draw_provider" style="width: 100%">
                                            <el-option
                                                v-for="p in availableProviders"
                                                :key="`primary-${p.value}`"
                                                :value="p.value"
                                                :label="p.value === 'gitee' ? `${p.label}（推荐）` : p.label"
                                            ></el-option>
                                        </el-select>
                                    </el-form-item>
                                </el-col>
                                <el-col :span="12">
                                    <el-form-item label="启用备用提供商">
                                        <el-switch v-model="providerConfig.enable_fallback" />
                                        <p class="text-xs text-pink-400 mt-1">主提供商失败时自动切换</p>
                                    </el-form-item>
                                </el-col>
                            </el-row>
                            <el-row :gutter="24" v-if="providerConfig.enable_fallback">
                                <el-col :span="12">
                                    <el-form-item label="第一备用模型">
                                        <el-select v-model="providerConfig.fallback_models[0]" style="width: 100%" @change="onFallbackChange(0)">
                                            <el-option v-for="p in availableProviders.filter(x => x.value !== providerConfig.draw_provider)" :key="`fb0-${p.value}`" :value="p.value" :label="p.label"></el-option>
                                        </el-select>
                                    </el-form-item>
                                </el-col>
                                <el-col :span="12">
                                    <el-form-item label="第二备用模型">
                                        <el-select v-model="providerConfig.fallback_models[1]" style="width: 100%" @change="onFallbackChange(1)">
                                            <el-option v-for="p in availableProviders.filter(x => x.value !== providerConfig.draw_provider)" :key="`fb1-${p.value}`" :value="p.value" :label="p.label"></el-option>
                                        </el-select>
                                    </el-form-item>
                                </el-col>
                            </el-row>
                        </el-form>
                    </el-card>

                    <!-- 改图功能配置卡片 -->
                    <el-card class="mb-6">
                        <template #header>
                            <div class="card-title">
                                <span class="icon">&#9998;</span>
                                <span>改图功能</span>
                            </div>
                        </template>
                        <el-form label-position="top">
                            <el-form-item label="启用改图功能">
                                <el-switch v-model="editConfig.enabled" />
                                <span class="text-sm text-gray-400 ml-3">启用后可使用 /改图 命令</span>
                            </el-form-item>
                            <el-row :gutter="20">
                                <el-col :span="8">
                                    <el-form-item label="改图提供商">
                                        <el-select v-model="editConfig.provider" style="width: 100%" @change="onEditProviderChange">
                                            <el-option value="gemini" label="Gemini"></el-option>
                                            <el-option value="gitee" label="Gitee (Qwen)"></el-option>
                                            <el-option value="grok" label="Grok"></el-option>
                                        </el-select>
                                        <p class="text-xs text-pink-400 mt-1">独立于生图主提供商，复用 API Key</p>
                                    </el-form-item>
                                </el-col>
                                <el-col :span="8">
                                    <el-form-item :label="editModelLabel">
                                        <el-input v-model="currentEditModel" :placeholder="editModelPlaceholder" />
                                        <p class="text-xs text-pink-400 mt-1">{{ editModelHint }}</p>
                                    </el-form-item>
                                </el-col>
                                <el-col :span="4" v-if="editConfig.provider === 'gitee'">
                                    <el-form-item label="轮询间隔 (秒)">
                                        <el-input-number v-model="editConfig.poll_interval" :min="1" :max="30" :step="1" style="width: 100%;" />
                                    </el-form-item>
                                </el-col>
                                <el-col :span="4" v-if="editConfig.provider === 'gitee'">
                                    <el-form-item label="轮询超时 (秒)">
                                        <el-input-number v-model="editConfig.poll_timeout" :min="60" :max="600" :step="30" style="width: 100%;" />
                                    </el-form-item>
                                </el-col>
                            </el-row>
                        </el-form>
                    </el-card>

                    <!-- 缓存清理配置卡片 -->
                    <el-card class="mb-6">
                        <template #header>
                            <div class="card-title">
                                <span class="icon">&#128451;</span>
                                <span>缓存清理</span>
                            </div>
                        </template>
                        <el-alert
                            title="清理规则说明"
                            type="info"
                            :closable="false"
                            style="margin-bottom: 1rem;"
                        >
                            <template #default>
                                <ul style="margin: 0; padding-left: 1.2rem; line-height: 1.8;">
                                    <li><strong>收藏保护</strong>：已收藏的图片永远不会被清理</li>
                                    <li><strong>优先清理旧图</strong>：按修改时间从旧到新依次清理</li>
                                    <li><strong>数量限制</strong>：当图片总数超过限制时，清理最旧的非收藏图片</li>
                                    <li><strong>空间限制</strong>：当总大小超过限制时，清理最旧的非收藏图片直到符合限制</li>
                                    <li><strong>双重检查</strong>：同时满足数量和空间两个限制条件</li>
                                </ul>
                            </template>
                        </el-alert>
                        <el-form label-position="top">
                            <el-row :gutter="24">
                                <el-col :span="12">
                                    <el-form-item label="最大存储空间 (MB)">
                                        <el-slider v-model="cacheConfig.max_storage_mb" :min="0" :max="2000" :step="50" show-input style="width: 100%" />
                                        <p class="text-xs text-pink-400 mt-1">超过此大小时清理旧图片，0 表示不限制</p>
                                    </el-form-item>
                                </el-col>
                                <el-col :span="12">
                                    <el-form-item label="最大图片数量">
                                        <el-slider v-model="cacheConfig.max_count" :min="0" :max="500" :step="10" show-input style="width: 100%" />
                                        <p class="text-xs text-pink-400 mt-1">超过此数量时清理旧图片，0 表示不限制</p>
                                    </el-form-item>
                                </el-col>
                            </el-row>
                            <el-divider />
                            <el-form-item>
                                <div style="display: flex; align-items: center; gap: 16px;">
                                    <el-button type="danger" @click="cleanupCache" :loading="cleaningCache">
                                        <span style="margin-right: 8px;">&#128465;</span> 立即清理缓存
                                    </el-button>
                                    <span class="text-sm text-gray-500">根据上方限制条件清理旧图片</span>
                                </div>
                            </el-form-item>
                        </el-form>
                    </el-card>
                </div>

                <!-- 环境场景页面 -->
                <div v-if="activeTab === 'environments'" class="max-w-4xl mx-auto fade-in">
                    <div class="page-header">
                        <h2 class="page-title">环境场景</h2>
                        <div class="flex gap-3">
                            <el-button type="success" @click="addEnvironment">
                                <span style="margin-right: 8px;">&#43;</span> 添加场景
                            </el-button>
                            <el-button type="primary" :loading="savingDynamic" @click="saveDynamicConfig">
                                <span style="margin-right: 8px;">&#128190;</span> 保存
                            </el-button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-500 mb-6">配置不同的环境场景，模型将根据用户输入的关键词自动选择合适的场景。拖拽可调整顺序。</p>

                    <div ref="envListRef">
                        <div v-for="(env, index) in environments" :key="env._id || index" class="list-item">
                            <div class="flex items-start gap-4">
                                <div class="drag-handle pt-2" style="cursor: grab;">
                                    <span style="font-size: 1.2rem;">&#9776;</span>
                                </div>
                                <div class="flex-1">
                                    <div class="flex gap-4 mb-3 items-center">
                                        <el-input v-model="env.name" placeholder="场景名称" style="width: 200px;" />
                                    </div>
                                    <div class="mb-3">
                                        <el-input v-model="env.keywordsStr" placeholder="触发关键词（逗号分隔，如：户外,公园,街道）" @input="parseKeywords(env)" />
                                    </div>
                                    <div class="mb-2" v-if="env.keywords && env.keywords.length > 0">
                                        <span v-for="kw in env.keywords" :key="kw" class="keyword-tag">{{ kw }}</span>
                                    </div>
                                    <el-input
                                        v-model="env.prompt"
                                        type="textarea"
                                        :autosize="{ minRows: 2, maxRows: 6 }"
                                        placeholder="场景 Prompt，例如: (indoors, bedroom aesthetic:1.3), (natural lighting:1.2)..."
                                    />
                                </div>
                                <el-button type="danger" circle @click="removeEnvironment(index)" title="删除场景" aria-label="删除场景" style="flex-shrink: 0;">
                                    <span>&#128465;</span>
                                </el-button>
                            </div>
                        </div>
                    </div>

                    <div v-if="environments.length === 0" class="empty-state">
                        <div class="icon">&#127968;</div>
                        <p class="text-lg mb-2">暂无环境场景</p>
                        <p class="text-sm">点击「添加场景」创建您的第一个环境</p>
                    </div>
                </div>

                <!-- 摄影模式页面 -->
                <div v-if="activeTab === 'cameras'" class="max-w-4xl mx-auto fade-in">
                    <div class="page-header">
                        <h2 class="page-title">摄影模式</h2>
                        <div class="flex gap-3">
                            <el-button type="success" @click="addCamera">
                                <span style="margin-right: 8px;">&#43;</span> 添加模式
                            </el-button>
                            <el-button type="primary" :loading="savingDynamic" @click="saveDynamicConfig">
                                <span style="margin-right: 8px;">&#128190;</span> 保存
                            </el-button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-500 mb-6">配置不同的镜头语言，模型将根据用户输入的关键词自动选择拍摄模式。拖拽可调整顺序。</p>

                    <div ref="camListRef">
                        <div v-for="(cam, index) in cameras" :key="cam._id || index" class="list-item">
                            <div class="flex items-start gap-4">
                                <div class="drag-handle pt-2" style="cursor: grab;">
                                    <span style="font-size: 1.2rem;">&#9776;</span>
                                </div>
                                <div class="flex-1">
                                    <div class="flex gap-4 mb-3 items-center">
                                        <el-input v-model="cam.name" placeholder="模式名称" style="width: 200px;" />
                                    </div>
                                    <div class="mb-3">
                                        <el-input v-model="cam.keywordsStr" placeholder="触发关键词（逗号分隔，如：全身,穿搭,OOTD）" @input="parseKeywords(cam)" />
                                    </div>
                                    <div class="mb-2" v-if="cam.keywords && cam.keywords.length > 0">
                                        <span v-for="kw in cam.keywords" :key="kw" class="keyword-tag">{{ kw }}</span>
                                    </div>
                                    <el-input
                                        v-model="cam.prompt"
                                        type="textarea"
                                        :autosize="{ minRows: 2, maxRows: 6 }"
                                        placeholder="镜头参数，例如: full body shot, wide angle, (fashion pose:1.3)..."
                                    />
                                </div>
                                <el-button type="danger" circle @click="removeCamera(index)" title="删除模式" aria-label="删除模式" style="flex-shrink: 0;">
                                    <span>&#128465;</span>
                                </el-button>
                            </div>
                        </div>
                    </div>

                    <div v-if="cameras.length === 0" class="empty-state">
                        <div class="icon">&#128247;</div>
                        <p class="text-lg mb-2">暂无摄影模式</p>
                        <p class="text-sm">点击「添加模式」创建您的第一个镜头设置</p>
                    </div>
                </div>

                <!-- 人像参考页面 -->
                <div v-if="activeTab === 'selfie'" class="max-w-4xl mx-auto fade-in">
                    <div class="page-header">
                        <h2 class="page-title">人像参考</h2>
                        <el-button type="primary" :loading="savingSelfie" @click="saveSelfieConfig">
                            <span style="margin-right: 8px;">&#128190;</span>
                            保存设置<span v-if="selfiePendingDeleteCount > 0">（删除 {{ selfiePendingDeleteCount }}）</span>
                        </el-button>
                    </div>
                    <p class="text-sm text-gray-500 mb-6">上传参考人像后，每次使用 Gemini 生图时会自动传入这些照片作为形象参考，确保角色形象一致性。</p>

                    <!-- 启用开关 -->
                    <el-card class="mb-6">
                        <template #header>
                            <div class="card-title">
                                <span class="icon">&#9881;</span>
                                <span>人像参考</span>
                            </div>
                        </template>
                        <el-form label-position="left">
                            <el-form-item label="启用人像参考功能" style="margin-bottom: 0;">
                                <div class="flex items-center gap-4">
                                    <el-switch v-model="selfieConfig.enabled" />
                                    <span class="text-sm text-gray-500">启用后，使用 Gemini 生图时会自动传入参考人像</span>
                                </div>
                            </el-form-item>
                        </el-form>
                    </el-card>

                    <!-- 上传区域 -->
                    <el-card class="mb-6">
                        <template #header>
                            <div class="card-title">
                                <span class="icon">&#128248;</span>
                                <span>上传人像参考</span>
                            </div>
                        </template>
                        <el-upload
                            ref="selfieUploadRef"
                            action=""
                            :auto-upload="false"
                            :on-change="handleSelfieFileChange"
                            :show-file-list="false"
                            accept="image/*"
                            multiple
                            drag
                        >
                            <div class="text-center py-8">
                                <div style="font-size: 3rem; color: #FFB6C1;">&#128247;</div>
                                <p class="text-pink-400 mt-4">点击或拖拽图片到此处上传</p>
                                <p class="text-xs text-gray-400 mt-2">支持 JPG、PNG、WebP 格式，建议上传清晰正脸照</p>
                            </div>
                        </el-upload>
                        <div v-if="selfieUploadFiles.length > 0" class="mt-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-sm text-gray-500">待上传文件 ({{ selfieUploadFiles.length }})</span>
                                <div class="flex gap-2">
                                    <el-button size="small" @click="clearSelfieUpload">清空</el-button>
                                    <el-button type="primary" size="small" :loading="uploadingSelfie" @click="uploadSelfieFiles">上传</el-button>
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                <span v-for="(f, idx) in selfieUploadFiles" :key="idx" class="keyword-tag">{{ f.name }}</span>
                            </div>
                        </div>
                    </el-card>

                    <!-- 已有人像参考列表 -->
                    <el-card>
                        <template #header>
                            <div class="card-title">
                                <span class="icon">&#128444;</span>
                                <span>已上传人像参考 ({{ selfieRefs.length }})</span>
                                <el-button v-if="selfieRefs.length > 0" type="danger" size="small" style="margin-left: auto;" @click="deleteAllSelfieRefs">
                                    清空全部
                                </el-button>
                                <span v-if="selfiePendingDeleteCount > 0" class="text-xs text-orange-500" style="margin-left: 12px;">
                                    已暂存删除 {{ selfiePendingDeleteCount }} 张，点击“保存设置”后生效，刷新可恢复。
                                </span>
                            </div>
                        </template>
                        <div v-if="selfieRefs.length === 0" class="empty-state" style="padding: 40px 20px;">
                            <div class="icon" style="font-size: 2.5rem;">&#128248;</div>
                            <p class="text-base mb-2">暂无人像参考</p>
                            <p class="text-sm">上传清晰正脸照作为形象参考</p>
                        </div>
                        <div v-else class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            <div v-for="ref in selfieRefs" :key="ref.name" class="image-card">
                                <img :src="ref.url" :alt="ref.name" loading="lazy" decoding="async" style="height: 180px;" />
                                <div class="actions">
                                    <el-button type="danger" circle @click="deleteSelfieRef(ref)" title="删除" aria-label="删除参考照">
                                        <span>&#128465;</span>
                                    </el-button>
                                </div>
                                <div class="image-info">
                                    <p class="text-xs text-gray-500 truncate" :title="ref.name">{{ ref.name }}</p>
                                </div>
                            </div>
                        </div>
                    </el-card>
                </div>

                <!-- 图片画廊页面 -->
                <div v-if="activeTab === 'gallery'" class="fade-in">
                    <div class="page-header">
                        <h2 class="page-title">图片画廊</h2>
                        <div class="flex gap-3">
                            <el-button-group>
                                <el-button :type="showFavoritesOnly ? 'primary' : ''" @click="toggleFavoritesFilter">
                                    <span style="margin-right: 6px;">&#9829;</span>
                                    {{ showFavoritesOnly ? '显示全部' : '只看收藏' }}
                                </el-button>
                            </el-button-group>
                            <el-button @click="loadImages" :loading="loadingImages">
                                <span style="margin-right: 8px;">&#128260;</span> 刷新
                            </el-button>
                        </div>
                    </div>

                    <!-- 统计栏 -->
                    <div class="stats-bar" v-if="totalImages > 0">
                        <div class="stat-item">
                            <div class="stat-value">{{ totalImages }}</div>
                            <div class="stat-label">总图片数</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" style="color: #FF69B4;">{{ favoriteCount }}</div>
                            <div class="stat-label">已收藏</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">{{ currentPage }}</div>
                            <div class="stat-label">当前页</div>
                        </div>
                    </div>

                    <!-- 筛选栏 -->
                    <div class="filter-bar mb-4 p-3 rounded-lg" style="background: rgba(255, 182, 193, 0.1); border: 1px solid rgba(255, 182, 193, 0.2);">
                        <div class="flex flex-wrap gap-3 items-center">
                            <span class="text-sm text-gray-500">筛选:</span>
                            <el-select v-model="filterModel" placeholder="生成模型" clearable size="small" style="width: 150px;" @change="applyFilters">
                                <el-option v-for="m in availableFilters.models" :key="m" :label="m" :value="m" />
                            </el-select>
                            <el-select v-model="filterSize" placeholder="尺寸" clearable size="small" style="width: 100px;" @change="applyFilters">
                                <el-option v-for="s in availableFilters.sizes" :key="s" :label="s" :value="s" />
                            </el-select>
                            <el-select v-model="filterCategory" placeholder="分类" clearable size="small" style="width: 120px;" @change="applyFilters">
                                <el-option v-for="c in availableFilters.categories" :key="c" :label="c === 'character' ? '人物' : (c === 'edit' ? '改图' : (c === 'other' ? '其他' : c))" :value="c" />
                            </el-select>
                            <el-button v-if="filterModel || filterSize || filterCategory" type="info" size="small" @click="clearFilters">
                                清除筛选
                            </el-button>
                        </div>
                    </div>

                    <!-- 空状态 -->
                    <div v-if="images.length === 0" class="empty-state">
                        <div class="icon">&#128444;</div>
                        <p class="text-lg mb-2">暂无生成的图片</p>
                        <p class="text-sm">使用 Gitee AI 生成图片后，将在此处显示</p>
                    </div>

                    <!-- 图片网格 -->
                    <div v-else class="grid gap-4" :style="{ gridTemplateColumns: `repeat(${galleryColumns}, minmax(0, 1fr))` }">
                        <div v-for="img in images" :key="img.name" class="image-card">
                            <!-- 收藏标记 -->
                            <div v-if="img.favorite" class="absolute top-2 right-2 z-10 text-pink-500" style="font-size: 1.2rem; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">&#9829;</div>
                            <img :src="img.thumbnail || img.url" :alt="img.name" @click="openImageDetail(img)" @keyup.enter="openImageDetail(img)" class="cursor-pointer" loading="lazy" decoding="async" tabindex="0" role="button" />
                            <div class="actions">
                                <div class="flex gap-2">
                                    <el-button :type="img.favorite ? 'warning' : 'default'" circle @click.stop="toggleFavorite(img)" :title="img.favorite ? '取消收藏' : '添加收藏'" :aria-label="img.favorite ? '取消收藏' : '添加收藏'">
                                        <span>{{ img.favorite ? '&#9829;' : '&#9825;' }}</span>
                                    </el-button>
                                    <el-button type="default" circle @click.stop="downloadImage(img)" title="下载" aria-label="下载图片">
                                        <span>&#8681;</span>
                                    </el-button>
                                    <el-button type="default" circle @click.stop="deleteImage(img)" title="删除" aria-label="删除图片">
                                        <span>&#10005;</span>
                                    </el-button>
                                </div>
                            </div>
                            <div class="image-info">
                                <p class="text-xs text-gray-500 truncate">{{ formatDate(img.mtime) }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- 分页 -->
                    <div v-if="totalImages > pageSize" class="mt-8 flex justify-center">
                        <el-pagination
                            v-model:current-page="currentPage"
                            :page-size="pageSize"
                            :total="totalImages"
                            layout="prev, pager, next"
                            @current-change="loadImages"
                            background
                        />
                    </div>
                </div>

                <!-- 视频画廊页面 -->
                <div v-if="activeTab === 'videos'" class="fade-in">
                    <div class="page-header">
                        <h2 class="page-title">视频画廊</h2>
                        <el-button @click="loadVideos" :loading="loadingVideos">
                            <span style="margin-right: 8px;">&#128260;</span> 刷新
                        </el-button>
                    </div>

                    <!-- 视频统计 -->
                    <div class="stats-bar" v-if="totalVideos > 0">
                        <div class="stat-item">
                            <div class="stat-value">{{ totalVideos }}</div>
                            <div class="stat-label">总视频数</div>
                        </div>
                    </div>

                    <!-- 视频空状态 -->
                    <div v-if="videos.length === 0 && !loadingVideos" class="empty-state">
                        <div class="icon">&#127916;</div>
                        <p>暂无生成的视频</p>
                        <p class="text-sm text-gray-400 mt-2">生成视频后将在此显示</p>
                    </div>

                    <!-- 视频网格 -->
                    <div v-else class="grid gap-4" :style="{ gridTemplateColumns: `repeat(${videoColumns}, minmax(0, 1fr))` }">
                        <div v-for="video in videos" :key="video.id" class="image-card" style="background: rgba(255,255,255,0.9); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
                            <video :src="video.url" controls preload="metadata" style="width: 100%; max-height: 160px; object-fit: contain; background: #000;"></video>
                            <div style="padding: 1rem;">
                                <p class="text-sm text-gray-600 truncate mb-3" :title="video.prompt || '无描述'">{{ video.prompt || '无描述' }}</p>
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-gray-400">{{ formatDate(video.created_at) }}</span>
                                    <div class="flex gap-2">
                                        <el-button type="primary" size="small" @click="openVideoUrl(video)">
                                            <span style="margin-right: 4px;">&#128279;</span> 打开
                                        </el-button>
                                        <el-button type="danger" size="small" @click="deleteVideo(video)">
                                            <span style="margin-right: 4px;">&#10005;</span> 删除
                                        </el-button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 视频分页 -->
                    <div v-if="totalVideos > videoPageSize" class="mt-8 flex justify-center">
                        <el-pagination
                            v-model:current-page="videoCurrentPage"
                            :page-size="videoPageSize"
                            :total="totalVideos"
                            layout="prev, pager, next"
                            @current-change="loadVideos"
                            background
                        />
                    </div>
                </div>

                <!-- 预设词设置页面 -->
                <div v-if="activeTab === 'videoPresets'" class="fade-in max-w-4xl mx-auto">
                    <div class="page-header">
                        <h2 class="page-title">预设词设置</h2>
                        <span class="text-sm text-gray-400">修改后自动保存</span>
                    </div>

                    <!-- 改图预设词 -->
                    <el-card class="mb-6">
                        <template #header>
                            <div class="card-title">
                                <span class="icon">&#9998;</span>
                                <span>改图预设词</span>
                                <el-button type="primary" size="small" @click="addEditPreset" style="margin-left: auto;">
                                    <span style="margin-right: 4px;">&#43;</span> 添加预设
                                </el-button>
                            </div>
                        </template>
                        <el-alert type="info" :closable="false" style="margin-bottom: 1rem;">
                            <template #title>
                                <span>格式：预设名:提示词，用户发送"/改图 预设名"时自动使用对应提示词</span>
                            </template>
                            <div class="text-sm mt-1" style="color: #666;">
                                例如：手办化:将图片转换为精致的手办模型风格
                            </div>
                        </el-alert>
                        <div v-if="editPresets.length === 0" class="empty-state">
                            <p>暂无改图预设词</p>
                            <p class="text-sm text-gray-400 mt-2">点击上方按钮添加预设词</p>
                        </div>
                        <div v-else class="flex flex-col gap-3">
                            <div v-for="(preset, index) in editPresets" :key="'edit-'+index" class="preset-card" style="background: rgba(255,255,255,0.9); border-radius: 12px; padding: 0.75rem 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
                                <el-input v-model="editPresets[index]" placeholder="预设名:提示词（如 手办化:将图片转换为手办风格）" @change="saveEditPresets">
                                    <template #suffix>
                                        <el-button type="danger" link @click="deleteEditPreset(index)" style="font-size: 1rem; padding: 0 8px;">
                                            &#10005;
                                        </el-button>
                                    </template>
                                </el-input>
                            </div>
                        </div>
                    </el-card>

                    <!-- 视频预设词 -->
                    <el-card>
                        <template #header>
                            <div class="card-title">
                                <span class="icon">&#127916;</span>
                                <span>视频预设词</span>
                                <el-button type="primary" size="small" @click="addVideoPreset" style="margin-left: auto;">
                                    <span style="margin-right: 4px;">&#43;</span> 添加预设
                                </el-button>
                            </div>
                        </template>
                        <el-alert type="info" :closable="false" style="margin-bottom: 1rem;">
                            <template #title>
                                <span>格式：预设名:提示词，用户发送"/视频 预设名"时自动使用对应提示词</span>
                            </template>
                            <div class="text-sm mt-1" style="color: #666;">
                                例如：微笑:让人物微笑，表情自然，眼睛有神
                            </div>
                        </el-alert>
                        <div v-if="videoPresets.length === 0" class="empty-state">
                            <p>暂无视频预设词</p>
                            <p class="text-sm text-gray-400 mt-2">点击上方按钮添加预设词</p>
                        </div>
                        <div v-else class="flex flex-col gap-3">
                            <div v-for="(preset, index) in videoPresets" :key="'video-'+index" class="preset-card" style="background: rgba(255,255,255,0.9); border-radius: 12px; padding: 0.75rem 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
                                <el-input v-model="videoPresets[index]" placeholder="预设名:提示词（如 微笑:让人物微笑）" @change="saveVideoPresets">
                                    <template #suffix>
                                        <el-button type="danger" link @click="deleteVideoPreset(index)" style="font-size: 1rem; padding: 0 8px;">
                                            &#10005;
                                        </el-button>
                                    </template>
                                </el-input>
                            </div>
                        </div>
                    </el-card>
                </div>
            </div>
        </div>

            <!-- 图片详情对话框 -->
            <el-dialog v-model="detailVisible" width="90%" :show-close="true" center destroy-on-close title="图片详情">
            <div class="flex flex-col lg:flex-row gap-6">
                <!-- 图片预览 -->
                <div class="lg:w-2/3">
                    <img ref="detailImageRef" :src="detailImage?.url" @load="onDetailImageLoad" style="width: 100%; max-height: 70vh; object-fit: contain; border-radius: 12px; border: 1px solid rgba(255, 182, 193, 0.3);" />
                </div>
                <!-- 详情信息 -->
                <div class="lg:w-1/3 flex flex-col gap-4">
                    <!-- 操作按钮 -->
                    <div class="flex gap-2 flex-wrap">
                        <el-button :type="detailImage?.favorite ? 'warning' : 'primary'" @click="toggleFavorite(detailImage)">
                            <span style="margin-right: 6px;">{{ detailImage?.favorite ? '&#9829;' : '&#9825;' }}</span>
                            {{ detailImage?.favorite ? '取消收藏' : '添加收藏' }}
                        </el-button>
                        <el-button type="danger" @click="deleteImageFromDetail">
                            <span style="margin-right: 6px;">&#128465;</span> 删除
                        </el-button>
                    </div>
                    <!-- 文件信息 -->
                    <el-card class="mb-2">
                        <template #header>
                            <div class="card-title" style="font-size: 0.9rem;">
                                <span class="icon">&#128196;</span>
                                <span>文件信息</span>
                            </div>
                        </template>
                        <div class="text-sm space-y-2">
                            <p><span class="text-gray-500">文件名:</span> {{ detailImage?.name }}</p>
                            <p><span class="text-gray-500">大小:</span> {{ formatSize(detailImage?.size) }}</p>
                            <p><span class="text-gray-500">尺寸:</span> {{ detailImageDimensions }}</p>
                            <p><span class="text-gray-500">创建时间:</span> {{ formatDate(detailImage?.ctime) }}</p>
                            <p v-if="detailImage?.model"><span class="text-gray-500">生成模型:</span> <el-tag size="small" type="info">{{ detailImage?.model }}</el-tag></p>
                            <p v-if="detailImage?.category"><span class="text-gray-500">分类:</span> <el-tag size="small" :type="detailImage?.category === 'character' ? 'success' : (detailImage?.category === 'edit' ? 'primary' : 'warning')">{{ detailImage?.category === 'character' ? '人物' : (detailImage?.category === 'edit' ? '改图' : detailImage?.category) }}</el-tag></p>
                        </div>
                    </el-card>
                    <!-- Prompt 信息 -->
                    <el-card v-if="detailImage?.prompt">
                        <template #header>
                            <div class="card-title" style="font-size: 0.9rem;">
                                <span class="icon">&#128221;</span>
                                <span>生成提示词</span>
                                <el-button type="primary" size="small" @click="copyPrompt" style="margin-left: auto;">复制</el-button>
                            </div>
                        </template>
                        <div class="text-sm" style="max-height: 200px; overflow-y: auto; word-break: break-all; line-height: 1.6;">
                            {{ detailImage?.prompt }}
                        </div>
                    </el-card>
                    <div v-else class="text-sm text-gray-400 text-center py-4">
                        暂无提示词信息
                    </div>
                </div>
            </div>
        </el-dialog>
        </div><!-- 主界面结束 -->
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const { createApp, ref, reactive, computed, onMounted, nextTick, watch } = Vue;

        // 从 URL 获取 token（用于首次认证）
        const urlParams = new URLSearchParams(window.location.search);
        let authToken = urlParams.get('token') || '';

        const app = createApp({
            setup() {
                // 登录状态
                const isAuthenticated = ref(false);
                const loginToken = ref('');
                const loginError = ref('');
                const loggingIn = ref(false);

                // 从 localStorage 恢复上次的 tab，默认 gallery
                const savedTab = localStorage.getItem('portrait_active_tab') || 'gallery';
                const activeTab = ref(savedTab);
                const mobileMenuOpen = ref(false);
                const saving = ref(false);
                const savingDynamic = ref(false);
                const loadingImages = ref(false);
                const config = reactive({
                    char_identity: '',
                    injection_rounds: 1,
                    cooldown_seconds: 0,
                    enable_env_injection: true,
                    enable_camera_injection: true,
                    proxy: '',
                });

                const giteeConfig = reactive({
                    api_keys: [],
                    base_url: 'https://ai.gitee.com/v1',
                    model: 'z-image-turbo',
                    size: '1024x1024',
                    num_inference_steps: 9,
                    negative_prompt: '',
                    timeout: 300,
                    max_retries: 2,
                });

                // 密钥显示控制
                const showGiteeKeys = ref(false);
                const showGeminiKey = ref(false);

                // 尺寸选项列表
                const sizeOptions = [
                    { value: '256x256', label: '256x256 (正方形)' },
                    { value: '512x512', label: '512x512 (正方形)' },
                    { value: '1024x1024', label: '1024x1024 (正方形/推荐)' },
                    { value: '2048x2048', label: '2048x2048 (正方形)' },
                    { value: '1152x896', label: '1152x896 (横版)' },
                    { value: '2048x1536', label: '2048x1536 (横版)' },
                    { value: '2048x1360', label: '2048x1360 (横版)' },
                    { value: '1024x576', label: '1024x576 (横版 16:9)' },
                    { value: '2048x1152', label: '2048x1152 (横版 16:9)' },
                    { value: '768x1024', label: '768x1024 (竖版)' },
                    { value: '1536x2048', label: '1536x2048 (竖版)' },
                    { value: '1360x2048', label: '1360x2048 (竖版)' },
                    { value: '576x1024', label: '576x1024 (竖版 9:16)' },
                    { value: '1152x2048', label: '1152x2048 (竖版 9:16)' },
                ];

                // Gemini 配置
                const geminiConfig = reactive({
                    api_key: '',
                    base_url: 'https://generativelanguage.googleapis.com',
                    model: 'gemini-2.0-flash-exp-image-generation',
                    image_size: '1K',
                    timeout: 120,
                });

                // Grok 配置
                const grokConfig = reactive({
                    api_key: '',
                    base_url: 'https://api.x.ai',
                    image_model: 'grok-imagine-1.0',
                    video_model: 'grok-imagine-1.0-video',
                    size: '1024x1024',
                    timeout: 180,
                    max_retries: 2,
                    video_enabled: false,
                    video_send_mode: 'auto',
                    max_cached_videos: 20,
                });
                const showGrokKey = ref(false);

                // 缓存配置
                const cacheConfig = reactive({
                    max_storage_mb: 500,
                    max_count: 100,
                });
                const cleaningCache = ref(false);

                // 改图配置
                const editConfig = reactive({
                    enabled: true,
                    provider: 'gemini',
                    model: 'Qwen-Image-Edit-2511',  // Gitee 改图模型
                    gemini_model: 'gemini-3-pro-image-preview',  // Gemini 改图模型
                    grok_model: 'grok-imagine-1.0',  // Grok 改图模型
                    poll_interval: 5,
                    poll_timeout: 300,
                    presets: ['手办化:将图片转换为精致的手办模型风格', 'Q版化:将图片转换为可爱的Q版卡通风格', '赛博朋克:添加霓虹灯光和未来科技感', '水彩画:转换为柔和的水彩画艺术风格', '油画:转换为经典油画艺术风格'],
                });

                // 提供商配置
                const providerConfig = reactive({
                    draw_provider: 'gitee',
                    enable_fallback: true,
                    fallback_models: ['gemini', 'grok'],
                });

                // 可选提供商列表
                const availableProviders = [
                    { value: 'gitee', label: 'Gitee AI' },
                    { value: 'gemini', label: 'Gemini AI' },
                    { value: 'grok', label: 'Grok AI' },
                ];

                // 监听主模型变化，自动调整备用模型
                watch(() => providerConfig.draw_provider, (newPrimary) => {
                    // 获取除主模型外的其他提供商
                    const others = availableProviders.filter(p => p.value !== newPrimary).map(p => p.value);
                    // 如果备用模型包含了新的主模型，重新分配
                    if (providerConfig.fallback_models.includes(newPrimary)) {
                        providerConfig.fallback_models = [...others];
                    }
                });

                // 当备用模型变更时，确保不重复
                function onFallbackChange(index) {
                    const other = index === 0 ? 1 : 0;
                    if (providerConfig.fallback_models[index] === providerConfig.fallback_models[other]) {
                        // 自动选择另一个可用的
                        const used = [providerConfig.draw_provider, providerConfig.fallback_models[index]];
                        const available = availableProviders.find(p => !used.includes(p.value));
                        if (available) {
                            providerConfig.fallback_models[other] = available.value;
                        }
                    }
                }

                const giteeKeysText = computed({
                    get: () => giteeConfig.api_keys.join('\n'),
                    set: (val) => {
                        giteeConfig.api_keys = val.split('\n').map(k => k.trim()).filter(k => k);
                    }
                });

                // 改图模型动态计算属性
                const editModelLabel = computed(() => {
                    switch (editConfig.provider) {
                        case 'gemini': return 'Gemini 改图模型';
                        case 'grok': return 'Grok 改图模型';
                        default: return 'Gitee 改图模型';
                    }
                });

                const editModelPlaceholder = computed(() => {
                    switch (editConfig.provider) {
                        case 'gemini': return 'gemini-3-pro-image-preview';
                        case 'grok': return 'grok-imagine-1.0';
                        default: return 'Qwen-Image-Edit-2511';
                    }
                });

                const editModelHint = computed(() => {
                    switch (editConfig.provider) {
                        case 'gemini': return '用于 Gemini 改图的模型';
                        case 'grok': return '用于 Grok 改图的模型';
                        default: return '用于 Gitee 改图的模型';
                    }
                });

                const currentEditModel = computed({
                    get: () => {
                        switch (editConfig.provider) {
                            case 'gemini': return editConfig.gemini_model;
                            case 'grok': return editConfig.grok_model;
                            default: return editConfig.model;
                        }
                    },
                    set: (val) => {
                        switch (editConfig.provider) {
                            case 'gemini': editConfig.gemini_model = val; break;
                            case 'grok': editConfig.grok_model = val; break;
                            default: editConfig.model = val; break;
                        }
                    }
                });

                // 切换改图提供商时，从文生图配置继承模型（如果当前为空）
                const onEditProviderChange = (provider) => {
                    switch (provider) {
                        case 'gemini':
                            if (!editConfig.gemini_model) {
                                editConfig.gemini_model = geminiConfig.model || 'gemini-3-pro-image-preview';
                            }
                            break;
                        case 'grok':
                            if (!editConfig.grok_model) {
                                editConfig.grok_model = grokConfig.image_model || 'grok-imagine-1.0';
                            }
                            break;
                        case 'gitee':
                            if (!editConfig.model) {
                                editConfig.model = 'Qwen-Image-Edit-2511';
                            }
                            break;
                    }
                };

                // 动态配置
                const environments = ref([]);
                const cameras = ref([]);

                // 引用
                const envListRef = ref(null);
                const camListRef = ref(null);

                const images = ref([]);
                const totalImages = ref(0);
                const currentPage = ref(1);
                const pageSize = ref(50);
                const showFavoritesOnly = ref(false);
                const favoriteCount = ref(0);
                const galleryColumns = ref(parseInt(localStorage.getItem('portrait_gallery_columns')) || 6);
                const videoColumns = ref(parseInt(localStorage.getItem('portrait_video_columns')) || 5);

                // 画廊筛选
                const filterModel = ref('');
                const filterSize = ref('');
                const filterCategory = ref('');
                const availableFilters = reactive({
                    models: [],
                    sizes: ['1K', '2K', '4K'],
                    categories: ['character', 'edit', 'other'],
                });

                // 视频画廊
                const videos = ref([]);
                const totalVideos = ref(0);
                const videoCurrentPage = ref(1);
                const videoPageSize = ref(20);
                const loadingVideos = ref(false);

                // 视频预设词
                const videoPresets = ref([]);

                // 缓存标志：避免重复加载
                const dataLoaded = reactive({
                    gallery: false,
                    videos: false,
                    settings: false,
                });

                const detailVisible = ref(false);
                const detailImage = ref(null);
                const detailImageDimensions = ref('加载中...');
                const detailImageRef = ref(null);

                // 人像参考相关
                const selfieConfig = reactive({
                    enabled: false,
                    reference_images: [],
                });
                const selfieRefs = ref([]);
                const selfieUploadFiles = ref([]);
                const selfieUploadRef = ref(null);
                const uploadingSelfie = ref(false);
                const savingSelfie = ref(false);
                const selfiePendingDeleteNames = ref([]);
                const selfiePendingDeleteCount = computed(() => selfiePendingDeleteNames.value.length);

                onMounted(async () => {
                    // 先尝试无 token 访问（检查是否需要认证）
                    try {
                        const res = await fetch('/api/health');
                        if (res.ok) {
                            // 不需要认证，直接进入
                            isAuthenticated.value = true;
                            await Promise.all([loadConfig(), loadImages(), loadVideos(), loadVideoPresets(), loadEditPresets()]);
                            nextTick(() => initSortable());
                            return;
                        }
                    } catch {}

                    // 需要认证：如果 URL 有 token 参数，自动设置 Cookie
                    if (authToken) {
                        try {
                            const res = await fetch('/api/auth', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ token: authToken }),
                            });
                            const data = await res.json();
                            if (data.success) {
                                // Cookie 已设置，清除 URL 中的 token 参数
                                authToken = '';
                                sessionStorage.removeItem('portrait_token');
                                // 从 URL 移除 token 参数
                                const url = new URL(window.location.href);
                                url.searchParams.delete('token');
                                window.history.replaceState({}, '', url.pathname + url.search);
                                isAuthenticated.value = true;
                                await Promise.all([loadConfig(), loadImages(), loadVideos(), loadVideoPresets(), loadEditPresets()]);
                                nextTick(() => initSortable());
                            }
                        } catch {}
                    }
                });

                // 登录（Cookie 认证）
                async function doLogin() {
                    if (!loginToken.value.trim()) {
                        loginError.value = '请输入访问令牌';
                        return;
                    }
                    loggingIn.value = true;
                    loginError.value = '';

                    try {
                        // 调用 /api/auth 设置 Cookie
                        const res = await fetch('/api/auth', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ token: loginToken.value.trim() }),
                        });
                        const data = await res.json();
                        if (data.success) {
                            // Cookie 已设置，不再需要 authToken
                            authToken = '';
                            sessionStorage.removeItem('portrait_token');
                            isAuthenticated.value = true;
                            // 加载数据
                            await Promise.all([loadConfig(), loadImages(), loadVideos(), loadVideoPresets(), loadEditPresets()]);
                            nextTick(() => initSortable());
                        } else {
                            loginError.value = data.error || '访问令牌无效';
                        }
                    } catch (e) {
                        loginError.value = '连接失败: ' + e.message;
                    } finally {
                        loggingIn.value = false;
                    }
                }

                // 监听 tab 切换，保存到 localStorage 并按需加载数据
                watch(activeTab, (newTab) => {
                    // 保存当前 tab 到 localStorage
                    localStorage.setItem('portrait_active_tab', newTab);
                    nextTick(() => {
                        initSortable();
                        // 仅在未缓存时加载数据
                        if (newTab === 'gallery' && !dataLoaded.gallery) {
                            loadImages();
                        } else if (newTab === 'videos' && !dataLoaded.videos) {
                            loadVideos();
                        } else if (newTab === 'settings' && !dataLoaded.settings) {
                            loadConfig();
                        }
                    });
                });

                // Sortable 实例追踪（防止内存泄漏）
                let sortableInstances = [];

                function initSortable() {
                    // 销毁旧实例防止内存泄漏
                    if (sortableInstances.length > 0) {
                        sortableInstances.forEach(inst => inst && inst.destroy());
                        sortableInstances = [];
                    }

                    const setupSortable = (el, list) => {
                        if (!el) return;
                        const instance = new Sortable(el, {
                            animation: 150,
                            handle: '.drag-handle',
                            ghostClass: 'sortable-ghost',
                            dragClass: 'sortable-drag',
                            onEnd: (evt) => {
                                const item = list.value.splice(evt.oldIndex, 1)[0];
                                list.value.splice(evt.newIndex, 0, item);
                            }
                        });
                        sortableInstances.push(instance);
                    };
                    setupSortable(envListRef.value, environments);
                    setupSortable(camListRef.value, cameras);
                }

                async function loadConfig() {
                    try {
                        const res = await fetch('/api/config');
                        const data = await res.json();
                        if (data.success && data.config) {
                            Object.assign(config, data.config);
                            if (data.config.gitee_config) {
                                Object.assign(giteeConfig, data.config.gitee_config);
                            }
                            // 加载 Gemini 配置
                            if (data.config.gemini_config) {
                                Object.assign(geminiConfig, data.config.gemini_config);
                            }
                            // 加载 Grok 配置
                            if (data.config.grok_config) {
                                Object.assign(grokConfig, data.config.grok_config);
                            }
                            // 加载缓存配置
                            if (data.config.cache_config) {
                                Object.assign(cacheConfig, data.config.cache_config);
                            }
                            // 加载改图配置
                            if (data.config.edit_config) {
                                Object.assign(editConfig, data.config.edit_config);
                            }
                            // 加载提供商配置
                            if (data.config.draw_provider) {
                                providerConfig.draw_provider = data.config.draw_provider;
                            }
                            if (data.config.enable_fallback !== undefined) {
                                providerConfig.enable_fallback = data.config.enable_fallback;
                            }
                            if (data.config.fallback_models && Array.isArray(data.config.fallback_models)) {
                                providerConfig.fallback_models = data.config.fallback_models;
                            }
                            // 加载动态配置
                            if (data.config.environments) {
                                environments.value = data.config.environments.map(e => ({
                                    ...e,
                                    _id: Math.random().toString(36).slice(2),
                                    keywordsStr: (e.keywords || []).join(', ')
                                }));
                            }
                            if (data.config.cameras) {
                                cameras.value = data.config.cameras.map(c => ({
                                    ...c,
                                    _id: Math.random().toString(36).slice(2),
                                    keywordsStr: (c.keywords || []).join(', ')
                                }));
                            }
                            // 加载人像参考配置
                            if (data.config.selfie_config) {
                                selfieConfig.enabled = data.config.selfie_config.enabled || false;
                                selfieConfig.reference_images = data.config.selfie_config.reference_images || [];
                            }
                        }
                        // 加载人像参考列表
                        await loadSelfieRefs();
                        dataLoaded.settings = true;
                    } catch (e) {
                        ElementPlus.ElMessage.error('加载配置失败: ' + e.message);
                    }
                }

                async function saveConfig() {
                    saving.value = true;
                    try {
                        // 准备动态配置
                        const envData = environments.value.map(e => ({
                            name: e.name,
                            keywords: e.keywords || [],
                            prompt: e.prompt
                        }));
                        const camData = cameras.value.map(c => ({
                            name: c.name,
                            keywords: c.keywords || [],
                            prompt: c.prompt
                        }));

                        const payload = {
                            config: {
                                ...config,
                                environments: envData,
                                cameras: camData,
                                gitee_config: { ...giteeConfig },
                                gemini_config: { ...geminiConfig },
                                grok_config: { ...grokConfig },
                                cache_config: { ...cacheConfig },
                                edit_config: { ...editConfig },
                                draw_provider: providerConfig.draw_provider,
                                enable_fallback: providerConfig.enable_fallback,
                                fallback_models: providerConfig.fallback_models,
                            }
                        };
                        const res = await fetch('/api/config', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const data = await res.json();
                        if (data.success) {
                            ElementPlus.ElMessage.success('配置保存成功！');
                        } else {
                            ElementPlus.ElMessage.error(data.error || '保存失败');
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error('保存失败: ' + e.message);
                    } finally {
                        saving.value = false;
                    }
                }

                async function cleanupCache() {
                    try {
                        await ElementPlus.ElMessageBox.confirm(
                            '确定要清理缓存吗？收藏的图片不会被删除。',
                            '确认清理',
                            { confirmButtonText: '确定', cancelButtonText: '取消', type: 'warning' }
                        );
                        cleaningCache.value = true;
                        const res = await fetch('/api/cache/cleanup', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                max_storage_mb: cacheConfig.max_storage_mb,
                                max_count: cacheConfig.max_count,
                            })
                        });
                        const data = await res.json();
                        if (data.success) {
                            ElementPlus.ElMessage.success(`清理完成！删除了 ${data.deleted_count || 0} 张图片，释放了 ${formatSize(data.freed_bytes || 0)}`);
                            await loadImages();
                        } else {
                            ElementPlus.ElMessage.error(data.error || '清理失败');
                        }
                    } catch (e) {
                        if (e !== 'cancel') {
                            ElementPlus.ElMessage.error('清理失败: ' + e.message);
                        }
                    } finally {
                        cleaningCache.value = false;
                    }
                }

                async function saveDynamicConfig() {
                    savingDynamic.value = true;
                    try {
                        const envData = environments.value.map(e => ({
                            name: e.name,
                            keywords: e.keywords || [],
                            prompt: e.prompt
                        }));
                        const camData = cameras.value.map(c => ({
                            name: c.name,
                            keywords: c.keywords || [],
                            prompt: c.prompt
                        }));

                        const res = await fetch('/api/dynamic-config', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                config: {
                                    environments: envData,
                                    cameras: camData
                                }
                            })
                        });
                        const data = await res.json();
                        if (data.success) {
                            ElementPlus.ElMessage.success('保存成功！');
                        } else {
                            ElementPlus.ElMessage.error(data.error || '保存失败');
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error('保存失败: ' + e.message);
                    } finally {
                        savingDynamic.value = false;
                    }
                }

                function parseKeywords(item) {
                    if (item.keywordsStr) {
                        item.keywords = item.keywordsStr.split(/[,，]/).map(k => k.trim()).filter(k => k);
                    } else {
                        item.keywords = [];
                    }
                }

                function addEnvironment() {
                    environments.value.push({
                        _id: Math.random().toString(36).slice(2),
                        name: '',
                        keywords: [],
                        keywordsStr: '',
                        prompt: ''
                    });
                    nextTick(() => initSortable());
                }

                function removeEnvironment(index) {
                    environments.value.splice(index, 1);
                }

                function addCamera() {
                    cameras.value.push({
                        _id: Math.random().toString(36).slice(2),
                        name: '',
                        keywords: [],
                        keywordsStr: '',
                        prompt: ''
                    });
                    nextTick(() => initSortable());
                }

                function removeCamera(index) {
                    cameras.value.splice(index, 1);
                }

                async function loadImages() {
                    loadingImages.value = true;
                    try {
                        const params = new URLSearchParams({
                            page: currentPage.value,
                            size: pageSize.value,
                        });
                        if (showFavoritesOnly.value) {
                            params.append('favorites', 'true');
                        }
                        if (filterModel.value) {
                            params.append('model', filterModel.value);
                        }
                        if (filterSize.value) {
                            params.append('filter_size', filterSize.value);
                        }
                        if (filterCategory.value) {
                            params.append('category', filterCategory.value);
                        }
                        const res = await fetch(`/api/images?${params}`);
                        const data = await res.json();
                        if (data.success) {
                            // Cookie 认证，不再需要在 URL 中添加 token
                            images.value = data.images;
                            totalImages.value = data.total;
                            // 使用后端返回的总收藏数量
                            favoriteCount.value = data.favorite_count || 0;
                            // 更新可用筛选选项
                            if (data.filters) {
                                availableFilters.models = data.filters.models || [];
                                availableFilters.sizes = data.filters.sizes || ['1K', '2K', '4K'];
                                availableFilters.categories = data.filters.categories || ['character', 'other'];
                            }
                            dataLoaded.gallery = true;
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error('加载图片失败: ' + e.message);
                    } finally {
                        loadingImages.value = false;
                    }
                }

                function toggleFavoritesFilter() {
                    showFavoritesOnly.value = !showFavoritesOnly.value;
                    currentPage.value = 1;
                    loadImages();
                }

                function saveGalleryColumns(val) {
                    localStorage.setItem('portrait_gallery_columns', val);
                }

                function saveVideoColumns(val) {
                    localStorage.setItem('portrait_video_columns', val);
                }

                function clearFilters() {
                    filterModel.value = '';
                    filterSize.value = '';
                    filterCategory.value = '';
                    currentPage.value = 1;
                    loadImages();
                }

                function applyFilters() {
                    currentPage.value = 1;
                    loadImages();
                }

                async function toggleFavorite(img) {
                    if (!img) return;
                    try {
                        const res = await fetch(`/api/images/${encodeURIComponent(img.name)}/favorite`, {
                            method: 'POST'
                        });
                        const data = await res.json();
                        if (data.success) {
                            img.favorite = data.favorite;
                            // 更新收藏计数（增减1）
                            favoriteCount.value += data.favorite ? 1 : -1;
                            ElementPlus.ElMessage.success(data.favorite ? '已添加收藏' : '已取消收藏');
                        } else {
                            ElementPlus.ElMessage.error(data.error || '操作失败');
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error('操作失败: ' + e.message);
                    }
                }

                function openImageDetail(img) {
                    detailImage.value = img;
                    detailImageDimensions.value = '加载中...';
                    detailVisible.value = true;
                    // 使用独立的 Image 对象获取尺寸，不依赖 DOM
                    if (img?.url) {
                        const tempImg = new Image();
                        tempImg.onload = function() {
                            detailImageDimensions.value = `${this.naturalWidth} x ${this.naturalHeight}`;
                        };
                        tempImg.onerror = function() {
                            detailImageDimensions.value = '无法获取';
                        };
                        tempImg.src = img.url;
                        // 如果图片已缓存，直接获取
                        if (tempImg.complete && tempImg.naturalWidth > 0) {
                            detailImageDimensions.value = `${tempImg.naturalWidth} x ${tempImg.naturalHeight}`;
                        }
                    }
                }

                function onDetailImageLoad(e) {
                    const img = e.target;
                    if (img.naturalWidth > 0) {
                        detailImageDimensions.value = `${img.naturalWidth} x ${img.naturalHeight}`;
                    }
                }

                async function deleteImageFromDetail() {
                    if (!detailImage.value) return;
                    await deleteImage(detailImage.value);
                    detailVisible.value = false;
                }

                function copyPrompt() {
                    if (!detailImage.value?.prompt) return;
                    navigator.clipboard.writeText(detailImage.value.prompt).then(() => {
                        ElementPlus.ElMessage.success('提示词已复制');
                    }).catch(() => {
                        ElementPlus.ElMessage.error('复制失败');
                    });
                }

                function formatSize(bytes) {
                    if (!bytes) return '0 B';
                    const units = ['B', 'KB', 'MB', 'GB'];
                    let i = 0;
                    while (bytes >= 1024 && i < units.length - 1) {
                        bytes /= 1024;
                        i++;
                    }
                    return bytes.toFixed(1) + ' ' + units[i];
                }

                async function deleteImage(img) {
                    try {
                        await ElementPlus.ElMessageBox.confirm(
                            `确定要删除图片 "${img.name}" 吗？`,
                            '确认删除',
                            { confirmButtonText: '删除', cancelButtonText: '取消', type: 'warning' }
                        );
                        const res = await fetch(`/api/images/${encodeURIComponent(img.name)}`, { method: 'DELETE', credentials: 'same-origin' });
                        const data = await res.json();
                        if (data.success) {
                            ElementPlus.ElMessage.success('图片已删除');
                            await loadImages();
                        } else {
                            ElementPlus.ElMessage.error(data.error || '删除失败');
                        }
                    } catch (e) {
                        if (e !== 'cancel') {
                            ElementPlus.ElMessage.error('删除失败: ' + e.message);
                        }
                    }
                }

                function downloadImage(img) {
                    // 使用隐藏的 <a> 标签触发下载
                    const link = document.createElement('a');
                    link.href = `/api/images/${encodeURIComponent(img.name)}/download`;
                    link.download = img.name;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }

                function formatDate(timestamp) {
                    if (!timestamp) return '';
                    return new Date(timestamp * 1000).toLocaleString('zh-CN');
                }

                // ========== 自拍人像参考 ==========
                async function loadSelfieRefs() {
                    try {
                        const res = await fetch('/api/selfie-refs');
                        const data = await res.json();
                        if (data.success) {
                            // Cookie 认证，不再需要在 URL 中添加 token
                            const refs = data.refs || [];
                            const pendingSet = new Set(selfiePendingDeleteNames.value);
                            selfieRefs.value = refs.filter((ref) => !pendingSet.has(ref.name));
                        }
                    } catch (e) {
                        console.error('加载人像参考失败:', e);
                    }
                }

                function handleSelfieFileChange(file) {
                    selfieUploadFiles.value.push(file.raw);
                }

                function clearSelfieUpload() {
                    selfieUploadFiles.value = [];
                }

                function markSelfieRefPendingDelete(name) {
                    if (!name) return;
                    if (!selfiePendingDeleteNames.value.includes(name)) {
                        selfiePendingDeleteNames.value.push(name);
                    }
                }

                async function commitPendingSelfieDeletes() {
                    if (selfiePendingDeleteNames.value.length === 0) {
                        return { deleted: 0, failed: [] };
                    }

                    const names = [...selfiePendingDeleteNames.value];
                    const failed = [];
                    let deleted = 0;

                    for (const name of names) {
                        try {
                            const res = await fetch(`/api/selfie-refs/${encodeURIComponent(name)}`, {
                                method: 'DELETE',
                                credentials: 'same-origin'
                            });
                            const data = await res.json();
                            if (data.success) {
                                deleted += 1;
                            } else {
                                failed.push(name);
                            }
                        } catch (e) {
                            failed.push(name);
                        }
                    }

                    selfiePendingDeleteNames.value = failed;
                    return { deleted, failed };
                }

                async function uploadSelfieFiles() {
                    if (selfieUploadFiles.value.length === 0) return;
                    uploadingSelfie.value = true;
                    try {
                        const formData = new FormData();
                        for (const file of selfieUploadFiles.value) {
                            formData.append('files', file);
                        }
                        const res = await fetch('/api/selfie-refs', {
                            method: 'POST',
                            body: formData,
                        });
                        const data = await res.json();
                        if (data.success) {
                            const count = data.uploaded ? data.uploaded.length : selfieUploadFiles.value.length;
                            ElementPlus.ElMessage.success(`成功上传 ${count} 张人像参考`);
                            selfieUploadFiles.value = [];
                            await loadSelfieRefs();
                        } else {
                            ElementPlus.ElMessage.error(data.error || '上传失败');
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error('上传失败: ' + e.message);
                    } finally {
                        uploadingSelfie.value = false;
                    }
                }

                async function deleteSelfieRef(ref) {
                    try {
                        await ElementPlus.ElMessageBox.confirm(
                            `确定要删除人像参考 "${ref.name}" 吗？`,
                            '确认删除',
                            { confirmButtonText: '删除', cancelButtonText: '取消', type: 'warning' }
                        );

                        markSelfieRefPendingDelete(ref.name);
                        selfieRefs.value = selfieRefs.value.filter((item) => item.name !== ref.name);
                        ElementPlus.ElMessage.success('已暂存删除，点击“保存设置”后生效');
                    } catch (e) {
                        if (e !== 'cancel') {
                            ElementPlus.ElMessage.error('删除失败: ' + e.message);
                        }
                    }
                }

                async function deleteAllSelfieRefs() {
                    if (selfieRefs.value.length === 0) return;
                    try {
                        await ElementPlus.ElMessageBox.confirm(
                            `确定要删除全部 ${selfieRefs.value.length} 张人像参考吗？`,
                            '确认清空',
                            { confirmButtonText: '全部删除', cancelButtonText: '取消', type: 'warning' }
                        );

                        const count = selfieRefs.value.length;
                        for (const ref of selfieRefs.value) {
                            markSelfieRefPendingDelete(ref.name);
                        }
                        selfieRefs.value = [];
                        ElementPlus.ElMessage.success(`已暂存清空 ${count} 张，点击“保存设置”后生效`);
                    } catch (e) {
                        if (e !== 'cancel') {
                            ElementPlus.ElMessage.error('操作失败: ' + e.message);
                        }
                    }
                }

                async function saveSelfieConfig() {
                    savingSelfie.value = true;
                    try {
                        const payload = {
                            config: {
                                selfie_config: {
                                    enabled: selfieConfig.enabled,
                                }
                            }
                        };
                        const res = await fetch('/api/config', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const data = await res.json();
                        if (data.success) {
                            const { deleted, failed } = await commitPendingSelfieDeletes();
                            if (failed.length > 0) {
                                ElementPlus.ElMessage.warning(`设置已保存，但 ${failed.length} 张参考照删除失败，请重试保存`);
                            } else if (deleted > 0) {
                                ElementPlus.ElMessage.success(`人像参考已保存，已删除 ${deleted} 张参考照`);
                            } else {
                                ElementPlus.ElMessage.success('人像参考已保存');
                            }
                            await loadSelfieRefs();
                        } else {
                            ElementPlus.ElMessage.error(data.error || '保存失败');
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error('保存失败: ' + e.message);
                    } finally {
                        savingSelfie.value = false;
                    }
                }

                // ========== 视频画廊 ==========
                async function loadVideos() {
                    loadingVideos.value = true;
                    try {
                        const params = new URLSearchParams();
                        params.append('page', videoCurrentPage.value);
                        params.append('page_size', videoPageSize.value);
                        const res = await fetch(`/api/videos?${params}`);
                        const data = await res.json();
                        if (data.success) {
                            videos.value = data.videos;
                            totalVideos.value = data.total;
                            dataLoaded.videos = true;
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error('加载视频失败: ' + e.message);
                    } finally {
                        loadingVideos.value = false;
                    }
                }

                async function deleteVideo(video) {
                    try {
                        await ElementPlus.ElMessageBox.confirm(
                            `确定要删除此视频吗？`,
                            '确认删除',
                            { confirmButtonText: '删除', cancelButtonText: '取消', type: 'warning' }
                        );
                        const res = await fetch(`/api/videos/${encodeURIComponent(video.id)}`, { method: 'DELETE', credentials: 'same-origin' });
                        const data = await res.json();
                        if (data.success) {
                            ElementPlus.ElMessage.success('视频已删除');
                            await loadVideos();
                        } else {
                            ElementPlus.ElMessage.error(data.error || '删除失败');
                        }
                    } catch (e) {
                        if (e !== 'cancel') {
                            ElementPlus.ElMessage.error('删除失败: ' + e.message);
                        }
                    }
                }

                function openVideoUrl(video) {
                    window.open(video.url, '_blank');
                }

                // ========== 视频预设词 ==========
                async function loadVideoPresets() {
                    try {
                        const res = await fetch('/api/video-presets', { credentials: 'same-origin' });
                        const data = await res.json();
                        if (data.success) {
                            videoPresets.value = data.presets || [];
                        }
                    } catch (e) {
                        console.error('加载视频预设词失败:', e);
                    }
                }

                async function saveVideoPresets() {
                    try {
                        const res = await fetch('/api/video-presets', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'same-origin',
                            body: JSON.stringify({ presets: videoPresets.value })
                        });
                        const data = await res.json();
                        if (data.success) {
                            ElementPlus.ElMessage.success('预设词已保存');
                        } else {
                            ElementPlus.ElMessage.error(data.error || '保存失败');
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error('保存失败: ' + e.message);
                    }
                }

                function addVideoPreset() {
                    videoPresets.value.push('');
                }

                function deleteVideoPreset(index) {
                    videoPresets.value.splice(index, 1);
                    saveVideoPresets();
                }

                // ========== 改图预设 ==========
                const editPresets = ref([]);

                async function loadEditPresets() {
                    try {
                        const res = await fetch('/api/edit-presets', { credentials: 'same-origin' });
                        const data = await res.json();
                        if (data.success) {
                            editPresets.value = data.presets || [];
                        }
                    } catch (e) {
                        console.error('加载改图预设词失败:', e);
                    }
                }

                async function saveEditPresets() {
                    try {
                        const res = await fetch('/api/edit-presets', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'same-origin',
                            body: JSON.stringify({ presets: editPresets.value })
                        });
                        const data = await res.json();
                        if (data.success) {
                            ElementPlus.ElMessage.success('改图预设词已保存');
                        } else {
                            ElementPlus.ElMessage.error(data.error || '保存失败');
                        }
                    } catch (e) {
                        ElementPlus.ElMessage.error('保存失败: ' + e.message);
                    }
                }

                function addEditPreset() {
                    editPresets.value.push('');
                }

                function deleteEditPreset(index) {
                    editPresets.value.splice(index, 1);
                    saveEditPresets();
                }

                return {
                    // 登录相关
                    isAuthenticated,
                    loginToken,
                    loginError,
                    loggingIn,
                    doLogin,
                    // 其他
                    activeTab,
                    mobileMenuOpen,
                    saving,
                    savingDynamic,
                    loadingImages,
                    config,
                    giteeConfig,
                    giteeKeysText,
                    showGiteeKeys,
                    showGeminiKey,
                    sizeOptions,
                    geminiConfig,
                    grokConfig,
                    showGrokKey,
                    cacheConfig,
                    cleaningCache,
                    cleanupCache,
                    editConfig,
                    editModelLabel,
                    editModelPlaceholder,
                    editModelHint,
                    currentEditModel,
                    onEditProviderChange,
                    editPresets,
                    loadEditPresets,
                    saveEditPresets,
                    addEditPreset,
                    deleteEditPreset,
                    providerConfig,
                    availableProviders,
                    onFallbackChange,
                    environments,
                    cameras,
                    envListRef,
                    camListRef,
                    images,
                    totalImages,
                    currentPage,
                    pageSize,
                    showFavoritesOnly,
                    favoriteCount,
                    galleryColumns,
                    saveGalleryColumns,
                    videoColumns,
                    saveVideoColumns,
                    filterModel,
                    filterSize,
                    filterCategory,
                    availableFilters,
                    clearFilters,
                    applyFilters,
                    detailVisible,
                    detailImage,
                    detailImageDimensions,
                    detailImageRef,
                    onDetailImageLoad,
                    saveConfig,
                    saveDynamicConfig,
                    parseKeywords,
                    addEnvironment,
                    removeEnvironment,
                    addCamera,
                    removeCamera,
                    loadImages,
                    deleteImage,
                    downloadImage,
                    toggleFavoritesFilter,
                    toggleFavorite,
                    openImageDetail,
                    deleteImageFromDetail,
                    copyPrompt,
                    formatDate,
                    formatSize,
                    // 人像参考
                    selfieConfig,
                    selfieRefs,
                    selfieUploadFiles,
                    selfieUploadRef,
                    uploadingSelfie,
                    savingSelfie,
                    selfiePendingDeleteCount,
                    loadSelfieRefs,
                    handleSelfieFileChange,
                    clearSelfieUpload,
                    uploadSelfieFiles,
                    deleteSelfieRef,
                    deleteAllSelfieRefs,
                    saveSelfieConfig,
                    // 视频画廊
                    videos,
                    totalVideos,
                    videoCurrentPage,
                    videoPageSize,
                    loadingVideos,
                    loadVideos,
                    deleteVideo,
                    openVideoUrl,
                    // 视频预设词
                    videoPresets,
                    loadVideoPresets,
                    saveVideoPresets,
                    addVideoPreset,
                    deleteVideoPreset,
                };
            }
        });

        app.use(ElementPlus);
        app.mount('#app');
      });
    </script>
</body>
</html>
